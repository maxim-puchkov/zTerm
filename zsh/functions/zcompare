#!/bin/zsh

#  zcompare
#  Generated by mkzsh at 07:15pm.
#
#  Created by mpuchkov/506:20 on April 16, 2021.
#  ~Projects/zTerm2/zsh/functions/zcompare


# FUNCTION
#   zcompare
#
# DESCRIPTION
#   ...
function zcompare {



# `is_any_newer_than <target> [file...]`
# Return 0 if any file is newer than the target file.
function is_any_newer_than {
  local target="$1"
  shift
  while [[ -n "$1" ]]; do
    if [[ "$1" -nt "$target" ]]; then
      return 0
    fi
    shift
  done
  return 1
}


#???: FUNCTION
#   zcompiled
#
# DESCRIPTION
#   Compile function directory.
function zcompiled {
  emulate -L zsh
  autoload -Uz error
  local -A opts=( --outdir "/tmp" )
  local -a specs=( '-outdir:' 'o:=-outdir' )
  zparseopts -D -F -K -M -A opts - $specs || return 2
  [[ -d "$1" ]]     || error -1 -m 'not a directory: ${1}'
  local -a files=( "${1}"/**(N-.) ) # files to compile
  [[ -n "$files" ]] || error -1 -m 'no files found in directory: ${1}'
  local zwc="${opts[--outdir]}/${1:t}.zwc" # output zwc file
  zcompare "$zwc" ${files[@]}
#  builtin zcompile -U -z -M "$zwc" ${files[@]} && echo "$zwc"
}

# Find position of zwc file in zcompile's arguments.
# E.g., pos=3 in '-U -z file.zwc file1 file2 file3'.
local -i pos=${argv[(i)[^-]*]}
[[ $pos -le $# ]] || return 1
local zwc="${argv[pos]%.zwc}.zwc"           # zwc file
local -a opts=( ${argv:1:$(( pos-1 ))} )    # zcompile options
local -a files                              # files to compile
if [[ $pos -eq $# ]]; then
  files=( ${argv[pos]} )
else
  files=( ${argv:$(( pos+1 ))} )
fi
if [[ ! -s "$zwc" ]] || is_any_newer_than "$zwc" $files[@]; then
  builtin zcompile $opts[@] "$zwc" $files[@]
  return 0
else
  return 1
fi

zcompare -U -z -R $ZDOTDIR/zwc/zshrc.zwc $ZDOTDIR/.zshrc
zcompare -U -z -R $ZDOTDIR/zwc/zprofile.zwc $ZDOTDIR/.zprofile
zcompare -U -z -M $ZDOTDIR/zwc/functions.zwc $ZDOTDIR/functions/*
zcompare -U -z -M $ZDOTDIR/zwc/completions.zwc $ZDOTDIR/completions/*



}

#!/bin/zsh

#  serror
#  devx
#
#  Created by admin on 2020-03-02.
#  Copyright Â© 2020 Maxim Puchkov. All rights reserved.


# Syntax error.
function serror() {
    local serror_syntax="serror keyword in_syntax [desc]"
    local default_desc="Undefined command parameter"
    
    # Arguments.
    local prefix_string=${(L)1}
    SYNTAX=( ${(Lz)${2}:-$SYNTAX} )
    local desc="${3:=$default_desc}"
    
    # Location and value of incorrect/missing keyword.
    local index=( ${(~)SYNTAX[(wi)$prefix_string*]} )
    local keyword=${SYNTAX[$index]}
    
    # Check for errors:
    ## Keyword prefix not defined.
    if [[ -z $prefix_string ]]; then
        echo "1"
        \serror "keyword" $serror_syntax "Keyword is not defined"
    fi
    ## Syntax not defined.
    if [[ -z $SYNTAX ]]; then
        echo "2"
        \serror "in_syntax" $serror_syntax "Syntax is not defined"
    fi
    ## Invalid keyword.
    if [[ $index -gt ${#SYNTAX} ]]; then
        \serror "in_syntax" $serror_syntax "Command syntax does not contain keywords strarting with '$prefix_string'."
    fi
    
    # Create styles for:
    ## Incorrect keyword.
    local keyword_style=$( group 'b_red' '<' '>' "$(underline "$keyword")" )
    ## Command until incorrect keyword.
    local cmd_name=${SYNTAX[1]}
    local cmd_name_style=$( bold $(bgreen "$cmd_name") )
    local cmd_valid=( ${SYNTAX:1:$(( $index - 2 ))} )
    local cmd_valid_style=$( green "$cmd_valid" )
    
    # Apply syntax highlighting.
    local syntax_highlight="$SYNTAX"
    syntax_highlight=( "${syntax_highlight/$cmd_name/$cmd_name_style}" )
    syntax_highlight=( "${syntax_highlight/$cmd_valid/$cmd_valid_style}" )
    syntax_highlight=( "${syntax_highlight/$keyword/$keyword_style}" )
    syntax_highlight=( "${syntax_highlight/$cmd_valid/$cmd_valid_style}" )
    
    # Display error.
    \error "${desc} '${keyword}':\n  ${syntax_highlight}"
}

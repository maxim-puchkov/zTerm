#!/bin/zsh

#  system-appearance-service
#  Services
#
#  Created by Maxim Puchkov on 2020-04-25.
#  Copyright Â© 2020 Maxim Puchkov. All rights reserved.

echo 'Hello!'
echo '------'

echo "Program: <$0>"
echo "Args: <$@>"


echo "$0 -- $@" > /Users/admin/Desktop/launched.txt

#autoload +Uz save_array
autoload +Uz error

autoload +Uz read_array
#
#CONFIG="$DEV/Terminal/.config/crontab/system-appearance"
#read_array settings $CONFIG
#echo $settings
#
#
#hash=("${(@)array1:^array2}")



#SETTINGS=(enabled begin_time end_time)

#while read setting; do
#    echo "cron setting = $setting"
#done < $SETTINGS
source $ZDOTDIR/.zio

typeset -A appearances
CFG_DIR="$DEV/Terminal/etc/SystemAppearance"
read_array appearances $CFG_DIR/appearances

hour=${1:-$( date +'%H' )};

if [[ $hour -ge 8 ]] && [[ $hour -lt 20 ]]; then
  action='off'
else
  action='on'
fi

echo $hour >> /Users/admin/Desktop/launched.txt
echo $action >> /Users/admin/Desktop/launched.txt
echo "$(date)" >> /Users/admin/Desktop/launched.txt


current=$( /usr/local/bin/dark-mode status )
if [[ $current == $action ]]; then
    echo 'service failed' >> /Users/admin/Desktop/launched.txt
  printf '%s %s\n' "${appearances[$current]}" 'appearance is already enabled.' >&2
  exit 1
fi

/usr/local/bin/dark-mode $action &> /dev/null
